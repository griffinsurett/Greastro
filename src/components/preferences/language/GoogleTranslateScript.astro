---
// src/components/preferences/language/GoogleTranslateScript.astro
/**
 * Google Translate Integration
 * 
 * Simple approach:
 * 1. Load Google Translate API
 * 2. On page load, read localStorage and set appropriate cookie
 * 3. User changes language → Save to localStorage → Reload
 */
---

<script is:inline>
  // Prevent scroll restoration
  if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
  }

  // Get cookie value
  function getCookie(name) {
    const value = '; ' + document.cookie;
    const parts = value.split('; ' + name + '=');
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  // Set cookie value
  function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
  }

  // Clear cookie completely
  function clearCookie(name) {
    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';
    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=' + window.location.hostname;
  }

  // Initialize Google Translate
  window.initializeGoogleTranslate = function() {
    if (typeof google === 'undefined' || !google.translate) return;

    const checkReady = setInterval(function() {
      if (google.translate.TranslateElement) {
        clearInterval(checkReady);
        
        new google.translate.TranslateElement({
          pageLanguage: 'en',
          includedLanguages: '',
          autoDisplay: false,
        }, 'google_translate_element');

        // Apply saved language after Google Translate loads
        setTimeout(function() {
          applySavedLanguage();
        }, 500);
      }
    }, 100);
  };

  // Apply language from localStorage
  function applySavedLanguage() {
    const savedLang = localStorage.getItem('user-language') || 'en';
    const currentCookie = getCookie('googtrans');
    const expectedCookie = savedLang === 'en' ? '' : '/en/' + savedLang;

    // If cookie matches saved preference, we're done
    if (currentCookie === expectedCookie) {
      return;
    }

    // Update cookie to match saved preference
    if (savedLang === 'en') {
      clearCookie('googtrans');
    } else {
      setCookie('googtrans', '/en/' + savedLang, 365);
    }

    // Reload to apply translation
    window.location.reload();
  }

  // Public function for language switcher to call
  window.changeLanguage = function(languageCode) {
    localStorage.setItem('user-language', languageCode);
    
    if (languageCode === 'en') {
      clearCookie('googtrans');
    } else {
      setCookie('googtrans', '/en/' + languageCode, 365);
    }
    
    window.location.reload();
  };

  // Load Google Translate script
  (function() {
    const script = document.createElement('script');
    script.src = 'https://translate.google.com/translate_a/element.js?cb=initializeGoogleTranslate';
    script.async = true;
    document.head.appendChild(script);
  })();
</script>

<div id="google_translate_element" style="display: none;"></div>

<style>
  .goog-te-banner-frame,
  .goog-te-balloon-frame,
  .goog-te-gadget,
  .skiptranslate,
  iframe.goog-te-menu-frame,
  #google_translate_element,
  body > .skiptranslate,
  iframe.skiptranslate {
    display: none !important;
  }

  body {
    top: 0 !important;
  }
</style>